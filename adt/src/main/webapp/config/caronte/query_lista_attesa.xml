<?xml version = "1.0"?>
<QUERIES>
	<QUERY_GROUP id="LISTA_ATTESA_FILTRI">
		<QUERY id="Q_REPARTI_CON_LISTA">
	    	<SQL>
				SELECT VALORE1 VALUE, VALORE3 DESCR
				FROM TABLE(FX$GET_CDC_PERSONALE(NULL, :USERNAME))
				WHERE VALORE1 IN (SELECT IDEN_CDC FROM LISTA_ATTESA_CDC)
				ORDER BY VALORE3
			</SQL>
			<BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
	    </QUERY>
	    <QUERY id="Q_LISTE_ATTESA_UTENTE">
	    	<SQL>
	    		SELECT * FROM
	    		(
	    			SELECT NULL AS VALUE , NULL AS DESCR, NULL AS CODICE_LISTA, NULL AS ID_WK, NULL AS BUTTONS FROM DUAL
	    			UNION ALL
                	SELECT ELENCO.IDEN AS VALUE , ELENCO.DESCRIZIONE AS DESCR, CODICE AS CODICE_LISTA, ID_WK, GETTAGVALUE(ELENCO.PARAMETRI,'buttons') AS BUTTONS
                	FROM
	                	LISTA_ATTESA_CDC CDC
    	            	INNER JOIN LISTA_ATTESA_ELENCO ELENCO ON ELENCO.IDEN = CDC.IDEN_LISTA
        	        WHERE
            	    	IDEN_CDC IN (SELECT VALORE1 IDEN FROM TABLE(FX$GET_CDC_PERSONALE(NULL, :USERNAME)))
                		and lista_chiamata = 'N' AND ELENCO.ATTIVO = 'S'
                )
                GROUP BY
					VALUE, DESCR, CODICE_LISTA, ID_WK, BUTTONS
			</SQL>
			<BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
	    </QUERY>
	    <QUERY id="Q_LISTE_REPARTO">
	    	<SQL>
				SELECT ELENCO.IDEN AS VALUE , ELENCO.DESCRIZIONE AS DESCR, CODICE AS CODICE_LISTA, ID_WK
				FROM
				  	LISTA_ATTESA_CDC CDC
				  	INNER JOIN LISTA_ATTESA_ELENCO ELENCO ON ELENCO.IDEN = CDC.IDEN_LISTA
				WHERE IDEN_CDC IN (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE ID_FILTRO = 'LISTA_ATTESA_REPARTO' AND USERNAME = :USERNAME)
				{#ORDER#}
			</SQL>
			<BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
	    </QUERY>
	    <QUERY id="Q_REPARTI_LISTA">
	    	<SQL>
				SELECT CODICE AS CODICE_DECODIFICA, IDEN AS VALUE, DESCRIZIONE AS DESCR
				FROM FX$CENTRI_DI_COSTO
				WHERE
					IDEN IN (SELECT IDEN_CDC FROM LISTA_ATTESA_CDC WHERE IDEN_LISTA = :IDEN_LISTA) AND
  					DESCRIZIONE LIKE :descr
  				{#ORDER#}
			</SQL>
	    </QUERY>
	    <QUERY id="Q_LIVELLO_PRIORITA">
            <SQL>
            	SELECT /*+ first_rows(10)*/ DESCRIZIONE AS DESCR, IDEN AS VALUE, PARAMETRI AS CLASS, CODICE_DECODIFICA AS CODICE_URGENZA
            	FROM TIPI
            	WHERE ATTIVO = 'S' AND TIPO = 'LISTA_ATTESA_PRIORITA' and ASSIGNING_AUTHORITY_AREA = 'ADT'
            	ORDER BY ORDINE
            </SQL>
        </QUERY>
	    <QUERY id="Q_STATO">
            <SQL>
                SELECT IDEN AS VALUE, DESCRIZIONE AS DESCR, CODICE_DECODIFICA AS CODICE
                FROM TIPI
                WHERE TIPO LIKE 'LISTA_ATTESA_STATO' AND ASSIGNING_AUTHORITY_AREA = 'ADT' AND ATTIVO = 'S'
                {#ORDER#}
            </SQL>
        </QUERY>
        <QUERY id="Q_MEDICO_PROPONENTE">
            <SQL>
				SELECT PERSONALE.IDEN VALUE, PERSONALE.DESCRIZIONE DESCR, PERSONALE.CODICE_FISCALE
				FROM
				  	FX$PERSONALE PERSONALE
				  	INNER JOIN FX$UTENTI UTENTI ON UTENTI.IDEN_PER = PERSONALE.IDEN
				  	INNER JOIN FX$WEB_CDC UTENTI_CDC ON UTENTI_CDC.WEBUSER = UTENTI.WEBUSER
				WHERE
				  	PERSONALE.ATTIVO = 'S' AND
				  	PERSONALE.TIPO_PERSONALE = 'M' AND
				  	UTENTI_CDC.REPARTO IN
				  	(
				  		SELECT COD_CDC
				  		FROM FX$CENTRI_DI_COSTO
				  		WHERE IDEN IN
				  		(
				  			SELECT IDEN_CDC
				  			FROM LISTA_ATTESA_CDC
				  			WHERE IDEN_LISTA IN
				  			(
				  				SELECT CODICE_NUMBER
				  				FROM FX$FILTRI
				  				WHERE ID_FILTRO = 'LISTA_ATTESA_ID' AND USERNAME = :USERNAME
				  			)
				  		)
				  	)
				GROUP BY
				  	PERSONALE.IDEN,PERSONALE.DESCRIZIONE,PERSONALE.CODICE_FISCALE
				{#ORDER#}
			</SQL>
			<BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
        </QUERY>
	</QUERY_GROUP>
	<QUERY_GROUP id="LISTA_ATTESA_PAGINA">
		<QUERY id="Q_DATI_INSERIMENTO">
            <SQL>
                SELECT
                	ANAG.IDEN AS IDEN_ANAGRAFICA,
				    ANAG.NOME,
				    ANAG.COGNOME,
				    ANAG.CODICE_FISCALE,
				    NVL(ANAG.RES_TELEFONO, ANAG.RES_CELLULARE) AS TELEFONO,
				    TRUNC(TRUNC(Months_Between(Sysdate, To_Date(ANAG.DATA_NASCITA, 'YYYYMMDD'))) / 12) ETA,
				    TO_CHAR(TO_DATE(ANAG.DATA_NASCITA, 'yyyyMMdd'),'dd/MM/yyyy') AS DATA_NASCITA,
				    NULL AS DATA_PRENOTAZIONE_CHAR,
				    NULL AS DATA_PRENOTAZIONE_ISO,
				    NULL AS ORA_PRENOTAZIONE,
				    NULL AS URGENZA,
				    NULL AS IDEN_CONTATTO,
				    1 AS CDC,
				    NULL AS IDEN_LISTA,
				    NULL AS STATO,
				    (SELECT IDEN_PER FROM FX$UTENTI WHERE WEBUSER = :USERNAME) AS IDEN_PER,
				    NULL IDEN,
				    :ID_LISTA AS ID_LISTA,
				    '{}' AS JSON_METADATI,
					null AS DIAGNOSI_ICD9,
					null AS INTERVENTO_ICD9,
					null AS MEDICO_PROPONENTE,
					null AS MEDICO_PRIMO_CHIRURGO,
					null AS REPARTO_DEGENZA,
				    (SELECT ID_TEMPLATE FROM LISTA_ATTESA_ELENCO WHERE IDEN = :ID_LISTA) AS TEMPLATE,
				    (SELECT DESCRIZIONE FROM LISTA_ATTESA_ELENCO WHERE IDEN = :ID_LISTA) AS NOME_LISTA,
				    NULL AS NOTE,
				    NULL AS NOTE_MODIFICA
				FROM
				    FX$ANAGRAFICa ANAG
				WHERE
				    ANAG.IDEN = :IDEN_ANAG
            </SQL>
            <BINDS>
                <BIND id="IDEN_ANAG" value="#IDEN_ANAG#" type="N"></BIND>
                <BIND id="ID_LISTA" value="#ID_LISTA#" type="V"></BIND>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
        </QUERY>
        <QUERY id="Q_DATI_MODIFICA">
            <SQL>
            	<![CDATA[
	               SELECT
					    ANAG.NOME,
					    ANAG.COGNOME,
					    ANAG.CODICE_FISCALE,
					    EXTRACTVALUE(LISTA_ATTESA.METADATI,'/METADATI/DATO[@KEY="txtNumeroTelefono"]') AS TELEFONO,
					    TRUNC(TRUNC(Months_Between(Sysdate, To_Date(ANAG.DATA_NASCITA, 'YYYYMMDD'))) / 12) ETA,
					    LISTA_ATTESA.urgenza,
					    LISTA_ATTESA.IDEN_CONTATTO,
					    LISTA_ATTESA.IDEN_ANAGRAFICA,
					    TO_CHAR(TO_DATE(ANAG.DATA_NASCITA, 'yyyyMMdd'),'dd/MM/yyyy') data_nascita,
					    LISTA_ATTESA.DATA_PRENOTAZIONE AS DATA_PRENOTAZIONE_DATE,
					    TO_CHAR(LISTA_ATTESA.DATA_PRENOTAZIONE,'dd/MM/yyyy') AS DATA_PRENOTAZIONE_CHAR,
					    TO_CHAR(LISTA_ATTESA.DATA_PRENOTAZIONE,'yyyyMMdd') AS DATA_PRENOTAZIONE_ISO,
					    TO_CHAR(LISTA_ATTESA.DATA_PRENOTAZIONE,'HH24:MI') AS ORA_PRENOTAZIONE,
					    LISTA_ATTESA.PROVENIENZA,
					    LISTA_ATTESA.CDC,
					    LISTA_ATTESA.IDEN_LISTA AS ID_LISTA,
					    LISTA_ATTESA.IDEN,
					    XMLTOJSON(METADATI) AS JSON_METADATI,
					    (SELECT CODICE || ' - ' || DESCRIZIONE FROM FX$ICD9 WHERE CODICE = (EXTRACTVALUE(LISTA_ATTESA.METADATI,'/METADATI/DATO[@KEY="h-txtDiagnosiICD"]')) )AS DIAGNOSI_ICD9,
					    (select
							intervento
							from lista_attesa_int_orma laio
							inner join lista_attesa_elenco lae on (lae.codice=laio.codreparto)
							where  lae.iden=LISTA_ATTESA.IDEN_LISTA and LAIO.ID = (EXTRACTVALUE(LISTA_ATTESA.METADATI,'/METADATI/DATO[@KEY="h-txtInterventoICD"]')) )
						AS INTERVENTO_ICD9,

					    (SELECT DESCRIZIONE FROM FX$PERSONALE WHERE IDEN = (EXTRACTVALUE(LISTA_ATTESA.METADATI,'/METADATI/DATO[@KEY="h-txtMedicoProponente"]'))) AS MEDICO_PROPONENTE,
					    (SELECT DESCRIZIONE FROM FX$PERSONALE WHERE IDEN = (EXTRACTVALUE(LISTA_ATTESA.METADATI,'/METADATI/DATO[@KEY="h-txtMedicoPrimoChirurgo"]'))) AS MEDICO_PRIMO_CHIRURGO,
					    (SELECT DESCRIZIONE FROM FX$CENTRI_DI_COSTO WHERE IDEN = (EXTRACTVALUE(LISTA_ATTESA.METADATI,'/METADATI/DATO[@KEY="h-txtRepartoDegenza"]'))) AS REPARTO_DEGENZA,
					    (SELECT ID_TEMPLATE FROM LISTA_ATTESA_ELENCO WHERE IDEN = LISTA_ATTESA.IDEN_LISTA) AS TEMPLATE,
					    (SELECT DESCRIZIONE FROM LISTA_ATTESA_ELENCO WHERE IDEN = LISTA_ATTESA.IDEN_LISTA) AS NOME_LISTA,
					    LISTA_ATTESA.NOTE,
					    LISTA_ATTESA.NOTE_MODIFICA,
					    LISTA_ATTESA.STATO
					FROM
					    FX$ANAGRAFICa ANAG
					  	LEFT OUTER JOIN ADT.LISTA_ATTESA ON ANAG.IDEN = LISTA_ATTESA.IDEN_ANAGRAFICA
					WHERE
					    LISTA_ATTESA.IDEN = :IDEN_LISTA
            	]]>
            </SQL>
            <BINDS>
                <BIND id="IDEN_LISTA" value="#IDEN_LISTA#" type="N"></BIND>
            </BINDS>
        </QUERY>
        <QUERY id="Q_MEDICO_PROPONENTE">
            <SQL>
				SELECT
					PERSONALE.IDEN VALUE,
				  	PERSONALE.DESCRIZIONE DESCR,
				 	PERSONALE.CODICE_FISCALE
				FROM
					FX$PERSONALE PERSONALE
				  	INNER JOIN FX$UTENTI UTENTI ON UTENTI.IDEN_PER = PERSONALE.IDEN
				  	INNER JOIN FX$WEB_CDC UTENTI_CDC ON UTENTI_CDC.WEBUSER = UTENTI.WEBUSER
				WHERE
				  	PERSONALE.ATTIVO  = 'S' AND
  					PERSONALE.DESCRIZIONE LIKE :descr AND
				  	PERSONALE.TIPO_PERSONALE = 'M' AND UTENTI_CDC.REPARTO IN
				  	(
				    	SELECT COD_CDC
				    	FROM FX$CENTRI_DI_COSTO
				    	WHERE IDEN IN (SELECT IDEN_CDC FROM LISTA_ATTESA_CDC WHERE IDEN_LISTA = :IDEN_LISTA)
				  	)
				GROUP BY
				  	PERSONALE.IDEN,PERSONALE.DESCRIZIONE,PERSONALE.CODICE_FISCALE
				 {#ORDER#}
			</SQL>
			<BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
        </QUERY>
        <QUERY id="Q_PREVISIONE_RICOVERO">
            <SQL>
                SELECT 'Assegnato' AS DESCR,'ASS' AS VALUE FROM DUAL UNION SELECT 'Richiesto' AS DESCR, 'PZ' AS VALUE FROM DUAL
            </SQL>
        </QUERY>
        <QUERY id="Q_CHECK_RX_ALLERGICO">
            <SQL>
                select 'Riferisce Allergie' DESCR, 'AL' VALUE from dual
            </SQL>
        </QUERY>
        <QUERY id="Q_CHECK_SOLVENTE_LIBERA_PROFESSIONE">
            <SQL>
                select 'Solvente' DESCR,'SLV' VALUE from dual
            </SQL>
        </QUERY>
        <QUERY id="Q_REGIME">
            <SQL>
                SELECT IDEN AS VALUE, DESCRIZIONE AS DESCR, CODICE_DECODIFICA AS CODICE, PARAMETRI FROM TIPI WHERE TIPO = 'LISTA_ATTESA_REGIME' ORDER BY ORDINE
            </SQL>
        </QUERY>
        <QUERY id="Q_ESITI_POSIZIONE">
            <SQL>
                SELECT
			  		IDEN, IDEN_CONTATTO,
			  		CODIFICHE.ENCODETIPO(LISTA_ATTESA.STATO) AS STATO_LISTA,
			  		(SELECT COUNT(1) FROM CONTATTI WHERE IDEN_PARENT = LISTA_ATTESA.IDEN_CONTATTO) AS N_RICOVERI
				FROM
			  		LISTA_ATTESA
				WHERE
			  		IDEN = :IDEN_LISTA_ATTESA
            </SQL>
            <BINDS>
                <BIND id="IDEN_LISTA_ATTESA" value="#IDEN_LISTA_ATTESA#" type="N"></BIND>
            </BINDS>
        </QUERY>
	</QUERY_GROUP>
	<QUERY_GROUP id="LISTA_ATTESA_WK">
		<QUERY id="LISTA_ATTESA_STD">
	    	<SQL>
	    		<![CDATA[
					SELECT
                        C.CODICE,
              			LISTA.IDEN IDEN_LISTA_ATTESA,
					    ELENCO.DESCRIZIONE AS NOME_LISTA_ATTESA,
					    ELENCO.IDEN AS ID_LISTA,
              			ELENCO.ID_TEMPLATE,
              			ELENCO.ABILITA_RICOVERO,
					    (SELECT DESCRIZIONE FROM FX$PERSONALE WHERE IDEN = LISTA.MEDICO_PROPONENTE) AS MEDICO_PROPONENTE_DESCRIZIONE,
					    LISTA.MEDICO_PROPONENTE AS MEDICO_PROPONENTE_IDEN,
					    LISTA.URGENZA PRIORITA_IDEN, CODIFICHE.ENCODETIPO(LISTA.URGENZA, 'ADT') AS PRIORITA_CODICE,
					    ANAG.IDEN, ANAG.NOME, ANAG.COGNOME, ANAG.SESSO SESSO, ANAG.CODICE_FISCALE CODICE_FISCALE,
					    ANAG.COGNOME || ' ' || ANAG.NOME || ' ' ||TO_CHAR(TO_DATE(ANAG.DATA_NASCITA,'yyyyMMdd'),'dd/MM/yyyy') AS ASSISTITO,
			    		EXTRACTVALUE(LISTA.METADATI,'/METADATI/DATO[@KEY="txtNumeroTelefono"]') AS TELEFONO,
					    (SELECT TRUNC(TRUNC(SYSDATE - TO_DATE(ANAG.DATA_NASCITA,'yyyyMMdd'))/365) FROM DUAL) AS ETA,
					    TO_CHAR(LISTA.DATA_PRENOTAZIONE,'yyyyMMddhh24:mi') AS DATA_PRENOTAZIONE_CHAR,
					    LISTA.DATA_PRENOTAZIONE AS DATA_PRENOTAZIONE_DATE,
					    CDC.DESCRIZIONE CDC_DESCRIZIONE, CDC.IDEN CDC_IDEN,
					    LISTA.URGENZA AS URGENZA_IDEN, CODIFICHE.ENCODETIPO(LISTA.URGENZA) AS URGENZA_CODICE, CODIFICHE.DESCRIBETIPO(LISTA.URGENZA) AS URGENZA_DESCRIZIONE,
					    LISTA.STATO AS STATO_IDEN, CODIFICHE.ENCODETIPO(LISTA.STATO,'ADT') AS STATO_CODICE, CODIFICHE.DESCRIBETIPO(LISTA.STATO,'ADT') AS STATO_DESCRIZIONE,
					    LISTA.IDEN_CONTATTO,
					    DECODE(CODIFICHE.ENCODETIPO(LISTA.STATO), 'ESITO_RICOVERO','RICOVERO','ESITO_PRERICOVERO','PRERICOVERO',NULL) AS ESITO,
					    LISTA.NOTE,
					    (SELECT TO_CHAR(MAX(DATA),'hh24:mi dd/MM/yyyy') FROM LISTA_ATTESA_ATTIVITA  WHERE IDEN_LISTA_ATTESA = LISTA.IDEN AND ATTIVITA = CODIFICHE.DECODETIPO('LISTA_ATTESA_ATTIVITA','CALL',NULL,'ADT')) AS DATA_ULTIMO_CONTATTO,
					    to_char(to_date(EXTRACTVALUE(LISTA.METADATI,'/METADATI/DATO[@KEY="txtDaDataPrevisione"]'), 'dd/MM/yyyy'),'yyyyMMdd') AS PERIODO_PREVISTO_DA,
					    to_char(to_date(extractvalue(lista.METADATI,'/METADATI/DATO[@KEY="txtADataPrevisione"]'), 'dd/MM/yyyy'), 'yyyyMMdd') AS PERIODO_PREVISTO_A
					FROM
					    LISTA_ATTESA LISTA
					    INNER JOIN LISTA_ATTESA_ELENCO ELENCO ON ELENCO.IDEN = LISTA.IDEN_LISTA
					    INNER JOIN FX$ANAGRAFICA ANAG ON ANAG.IDEN = LISTA.IDEN_ANAGRAFICA
					    INNER JOIN FX$CENTRI_DI_COSTO CDC ON CDC.IDEN = LISTA.CDC
              			LEFT OUTER JOIN CONTATTI C ON C.IDEN = LISTA.IDEN_CONTATTO
					WHERE
					    ANAG.NOME LIKE :nome AND ANAG.COGNOME LIKE :cognome and LISTA.ASSIGNING_AUTHORITY_AREA = 'ADT' AND LISTA.DELETED = 'N'
					    AND LISTA.STATO IN (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE USERNAME = :username AND ID_FILTRO = 'LISTA_ATTESA_STATO')
					    and TRUNC(LISTA.DATA_PRENOTAZIONE) >= to_date((SELECT CODICE_NUMBER FROM FX$FILTRI WHERE USERNAME = :username AND ID_FILTRO = 'LISTA_ATTESA_DATA_INIZIO') ,'yyyyMMdd')
					    and TRUNC(LISTA.DATA_PRENOTAZIONE) <= to_date((SELECT CODICE_NUMBER FROM FX$FILTRI WHERE USERNAME = :username AND ID_FILTRO = 'LISTA_ATTESA_DATA_FINE') ,'yyyyMMdd')+1
					    AND LISTA.IDEN_LISTA IN (select CODICE_NUMBER FROM FX$FILTRI where ID_FILTRO= 'LISTA_ATTESA_ID' and USERNAME = :username)
					    AND LISTA.URGENZA IN (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE USERNAME = :username AND ID_FILTRO = 'LISTA_ATTESA_PRIORITA') AND
					    (
    						LISTA.MEDICO_PROPONENTE IS NULL OR
    						LISTA.MEDICO_PROPONENTE IN (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE USERNAME = :username AND ID_FILTRO = 'LISTA_ATTESA_MEDICO_PROPONENTE')
  						)
  						AND (C.STATO IN (SELECT CODIFICHE.DECODETIPO('STATO', CODICE_VARCHAR, NULL, 'ADT') FROM FX$FILTRI where ID_FILTRO= 'LISTA_ATTESA_STATO_CONTATTO' and USERNAME = :username) OR C.STATO IS NULL)
  					{#ORDER#}
				]]>
			</SQL>
	    </QUERY>
	    <QUERY id="Q_RIEPILOGO">
        	<SQL>
        		SELECT
			  		LISTA.IDEN,
			  		LISTA.IDEN_ORIGINALE,
			  		CODIFICHE.DESCRIBETIPO(LISTA.URGENZA,'ADT') as URGENZA_DESCRIZIONE,
			  		LISTA.NOTE AS NOTE,
			  		LISTA.NOTE_MODIFICA AS NOTE_MODIFICA,
				  	(SELECT DESCRIZIONE FROM FX$PERSONALE WHERE IDEN IN (COALESCE(lista.UTENTE_MODIFICA,lista.UTENTE_INSERIMENTO))) AS UTENTE,
				  	TO_CHAR(LISTA.DATA_INS_BCK,'dd/MM/yyyy hh24:mi') AS DATA_MODIFICA,
				  	TO_CHAR(LISTA.DATA_PRENOTAZIONE,'dd/MM/yyyy hh24:mi') AS DATA_PRENOTAZIONE,
				  	CODIFICHE.DESCRIBETIPO(LISTA.STATO,'ADT') as STATO_DESCRIZIONE
				FROM
  					ADT_BCK.LISTA_ATTESA LISTA
  					INNER JOIN FX$ANAGRAFICA AN ON (LISTA.IDEN_ANAGRAFICA = AN.IDEN)
				WHERE
  					LISTA.IDEN_ORIGINALE = :IDEN_LISTA
				{#ORDER#}
			</SQL>
        </QUERY>
        <QUERY id="Q_ATTIVITA">
        	<SQL>
        		SELECT
				  	(SELECT DESCRIZIONE FROM TIPI WHERE IDEN = ATTIVITA.ATTIVITA) as DESCR_ATTIVITA,
				  	(SELECT DESCRIZIONE FROM FX$PERSONALE WHERE IDEN = ATTIVITA.UTENTE_INSERIMENTO) AS UTENTE,
				  	TO_CHAR(ATTIVITA.DATA,'dd/MM/yyyy hh24:mi') DATA_ATTIVITA,
				  	ATTIVITA.NOTE as NOTE_ATTIVITA
				FROM
				  	ADT.LISTA_ATTESA_ATTIVITA ATTIVITA
				WHERE
				  	ATTIVITA.IDEN_LISTA_ATTESA = :IDEN_LISTA_ATTESA
				ORDER BY
				  	ATTIVITA.IDEN DESC
			</SQL>
        </QUERY>
	</QUERY_GROUP>
	<QUERY_GROUP id="LISTA_CHIAMATA_FILTRI">
		<QUERY id="Q_LISTE_CHIAMATA_UTENTE">
            <SQL>
            	SELECT NULL AS VALUE , NULL AS DESCR, NULL AS CODICE_LISTA, NULL AS ID_WK FROM DUAL
	    		UNION ALL
                SELECT
				  	CHIAMATA.IDEN AS VALUE , CHIAMATA.DESCRIZIONE AS DESCR, CHIAMATA.CODICE AS CODICE, CHIAMATA.ID_WK AS ID_WK
				FROM
				  	LISTA_ATTESA_CDC CDC
				  	INNER JOIN LISTA_ATTESA_ELENCO ATTESA ON ATTESA.IDEN = CDC.IDEN_LISTA
				  	INNER JOIN LISTA_ATTESA_ELENCO CHIAMATA ON CHIAMATA.IDEN = ATTESA.ID_LISTA_CHIAMATA
				WHERE
				  	IDEN_CDC IN (SELECT VALORE1 IDEN FROM TABLE(FX$GET_CDC_PERSONALE(NULL, :USERNAME))) AND
				  	ATTESA.ATTIVO = 'S'
				GROUP BY
				  	CHIAMATA.IDEN, CHIAMATA.DESCRIZIONE, CHIAMATA.CODICE, CHIAMATA.ID_WK
                {#ORDER#}
            </SQL>
            <BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
        </QUERY>
		<QUERY id="Q_MEDICO_PROPONENTE">
            <SQL>
				SELECT PERSONALE.IDEN VALUE, PERSONALE.DESCRIZIONE DESCR, PERSONALE.CODICE_FISCALE
				FROM
				  	FX$PERSONALE PERSONALE
				  	INNER JOIN FX$UTENTI UTENTI ON UTENTI.IDEN_PER = PERSONALE.IDEN
				  	INNER JOIN FX$WEB_CDC UTENTI_CDC ON UTENTI_CDC.WEBUSER = UTENTI.WEBUSER
				WHERE
				  	PERSONALE.ATTIVO = 'S' AND
				  	PERSONALE.TIPO_PERSONALE = 'M' AND
				  	UTENTI_CDC.REPARTO IN
				  	(
				  		SELECT COD_CDC
				  		FROM FX$CENTRI_DI_COSTO
				  		WHERE IDEN IN
				  		(
				  			SELECT IDEN_CDC
				  			FROM LISTA_ATTESA_CDC
				  			WHERE IDEN_LISTA IN
                			(
                  				SELECT IDEN
                  				FROM LISTA_ATTESA_ELENCO
                  				WHERE ID_LISTA_CHIAMATA IN
                  				(
                    				SELECT CODICE_NUMBER
                    				FROM FX$FILTRI
                    				WHERE ID_FILTRO = 'LISTA_CHIAMATA_ID' AND USERNAME = :USERNAME
                  				)
                			)
				  		)
				  	)
				GROUP BY
				  	PERSONALE.IDEN,PERSONALE.DESCRIZIONE,PERSONALE.CODICE_FISCALE
				ORDER BY
					PERSONALE.DESCRIZIONE
			</SQL>
			<BINDS>
                <BIND id="USERNAME" value="#USERNAME#" type="V"></BIND>
            </BINDS>
        </QUERY>
	</QUERY_GROUP>
    <QUERY_GROUP id = "LISTA_CHIAMATA_WK">
        <QUERY id ="LISTA_CHIAMATA_STD">
            <SQL>
            	<![CDATA[
            		SELECT RANK_PZ_FILTER.* FROM
					(
  						SELECT RANK_PZ.*, ROWNUM AS POSIZIONE_PAZIENTE FROM
  						(
	    					SELECT
	      						LISTA.IDEN_LISTA,
	      						LISTA.IDEN_CONTATTO,
	      						CONTATTI.CODICE AS NOSOLOGICO, CODIFICHE.ENCODETIPO(CONTATTI.REGIME,'ADT') AS CONTATTO_REGIME_CODICE,
	      						CODIFICHE.ENCODETIPO(LISTA.STATO) AS LISTA_ATTESA_STATO,
	      						ELENCO.DESCRIZIONE AS NOME_LISTA_ATTESA,
	      						ELENCO.IDEN AS ID_LISTA,
	      						LISTA.MEDICO_PROPONENTE AS MEDICO_PROPONENTE_IDEN,
	      						(SELECT DESCRIZIONE FROM FX$PERSONALE WHERE IDEN = LISTA.MEDICO_PROPONENTE) AS MEDICO_PROPONENTE_DESCRIZIONE,
	      						LISTA.IDEN AS IDEN_LISTA_ATTESA,
	      						ANAG.IDEN, ANAG.NOME, ANAG.COGNOME, ANAG.SESSO SESSO, ANAG.CODICE_FISCALE CODICE_FISCALE,
	      						(SELECT TRUNC(TRUNC(SYSDATE - TO_DATE(ANAG.data_nascita,'yyyyMMdd'))/365) FROM DUAL) eta,
	      						ANAG.COGNOME || ' ' || ANAG.NOME || ' ' ||TO_CHAR(TO_DATE(ANAG.DATA_NASCITA,'yyyyMMdd'),'dd/MM/yyyy') ASSISTITO,
	      						TO_CHAR(LISTA.DATA_PRENOTAZIONE,'hh24:mi dd/MM/yyyy') AS DATA_PRENOTAZIONE_CHAR,
	      					   	LISTA.DATA_PRENOTAZIONE AS DATA_PRENOTAZIONE_DATE,
	      						CDC.DESCRIZIONE CDC_DESCRIZIONE, CDC.IDEN CDC_IDEN,
	      						LISTA.URGENZA PRIORITA_IDEN, CODIFICHE.ENCODETIPO(LISTA.URGENZA, 'ADT') AS PRIORITA_CODICE,
	      						CODIFICHE.DESCRIBETIPO(LISTA.URGENZA,'ADT') AS PRIORITA_DESCRIZIONE,
	      						EXTRACTVALUE(LISTA.METADATI,'/METADATI/DATO[@KEY="txtDaDataPrevisione"]') || ' - ' || EXTRACTVALUE(LISTA.METADATI,'/METADATI/DATO[@KEY="txtADataPrevisione"]') AS PERIODO_PREVISTO,
	      						DECODE(CODIFICHE.ENCODETIPO(LISTA.STATO), 'ESITO_RICOVERO','RICOVERO','ESITO_PRERICOVERO','PRERICOVERO',NULL) AS ESITO,
	      						(SELECT TO_CHAR(MAX(DATA),'hh24:mi dd/MM/yyyy') FROM LISTA_ATTESA_ATTIVITA  WHERE IDEN_LISTA_ATTESA = LISTA.IDEN AND ATTIVITA = CODIFICHE.DECODETIPO('LISTA_ATTESA_ATTIVITA','CALL',NULL,'ADT')) AS DATA_ULTIMO_CONTATTO
	    					FROM
	      						LISTA_ATTESA LISTA
	      						INNER JOIN LISTA_ATTESA_ELENCO ELENCO ON ELENCO.IDEN = LISTA.IDEN_LISTA
	      						INNER JOIN FX$ANAGRAFICA ANAG ON ANAG.IDEN = LISTA.IDEN_ANAGRAFICA
	      						LEFT OUTER JOIN FX$CENTRI_DI_COSTO CDC ON CDC.IDEN = LISTA.CDC
	      						LEFT OUTER JOIN CONTATTI ON CONTATTI.IDEN = LISTA.IDEN_CONTATTO
	    					WHERE
	      						LISTA.STATO = CODIFICHE.DECODETIPO('LISTA_ATTESA_STATO','INSERITO',NULL,'ADT') AND
	      						LISTA.ASSIGNING_AUTHORITY_AREA = 'ADT' AND LISTA.DELETED = 'N' AND
	      						IDEN_LISTA IN
	      						(
	        						SELECT IDEN FROM LISTA_ATTESA_ELENCO WHERE ID_LISTA_CHIAMATA = (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE ID_FILTRO= 'LISTA_CHIAMATA_ID' AND USERNAME = :username)
	      						)
	    					ORDER BY
	      						PRIORITA_CODICE ASC, LISTA.DATA_PRENOTAZIONE ASC
  						) RANK_PZ
					) RANK_PZ_FILTER
					WHERE
  						RANK_PZ_FILTER.COGNOME LIKE :cognome AND NOME LIKE :nome AND
  						(
    						RANK_PZ_FILTER.MEDICO_PROPONENTE_IDEN IS NULL OR
    						RANK_PZ_FILTER.MEDICO_PROPONENTE_IDEN IN (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE USERNAME = :username AND ID_FILTRO = 'LISTA_CHIAMATA_MEDICO_PROPONENTE')
  						) AND
  						RANK_PZ_FILTER.POSIZIONE_PAZIENTE < (SELECT NUMERO_PAZIENTI FROM LISTA_ATTESA_ELENCO WHERE IDEN = (SELECT CODICE_NUMBER FROM FX$FILTRI WHERE ID_FILTRO= 'LISTA_CHIAMATA_ID' AND USERNAME = :username))
  					{#ORDER#}
            	]]></SQL>
        </QUERY>
    </QUERY_GROUP>
</QUERIES>
